(function(t){"use strict";function e(e){t.Object.call(this,2,e),i.fixAR(this);var r=this._;r.mode="",r.bufferL=new i.SignalArray(s<<2),r.bufferR=new i.SignalArray(s<<2),r.buffermask=r.bufferL.length-1,r.node=null,r.script=n.createJavaScriptNode(s,2,2),r.writeIndex=0,r.readIndex=0,r.totalRead=0,r.totalWrite=0}if("webkit"===t.env){var i=t.fn,n=i._audioContext,s=1024;i.extend(e);var r=e.prototype;Object.defineProperties(r,{context:{get:function(){return n}},mode:{get:function(){return this._.mode}}}),r.cancel=function(){for(var t=this._,e=this.cells[0],i=0,n=e.length;n>i;++i)e[i]=0;t.node=null},function(){function t(t){e.call(this,t);var i=this._;i.mode="recv",i.script.onaudioprocess=s(this),i.gain=n.createGainNode(),i.gain.gain.value=0,i.script.connect(i.gain)}i.extend(t,e);var s=function(t){return function(e){var i=t._,n=e.inputBuffer,s=n.getChannelData(0),r=n.getChannelData(1),a=n.length,o=i.writeIndex;i.bufferL.set(s,o),i.bufferR.set(r,o),i.writeIndex=o+a&i.buffermask,i.totalWrite+=a}},r=t.prototype;r.cancel=function(){e.prototype.cancel.call(this),this._.gain.disconnect(),this._.node&&this._.node.disconnect()},r.recv=function(t){var e=this._;try{e.node=t,e.node.connect(e.script),e.gain.connect(n.destination)}catch(i){e.node=null}return e.writeIndex=0,e.readIndex=0,e.totalWrite=0,e.totalRead=0,this},r.process=function(t){var e=this._;if(null===e.node)return this;if(this.tickID!==t){this.tickID=t;var n=e.cellsize,s=e.bufferL,r=e.bufferR;if(e.totalWrite>e.totalRead+n){var a=e.readIndex,o=a+n;this.cells[1].set(s.subarray(a,o)),this.cells[2].set(r.subarray(a,o)),e.readIndex=o&e.buffermask,e.totalRead+=n}i.outputSignalAR(this)}return this},i.register("WebAudioAPI:recv",t)}(),function(){function t(t){e.call(this,t),i.listener(this);var s=this._;s.mode="send",s.script.onaudioprocess=n(this),s.connectIndex=null}i.extend(t,e);var n=function(t){return function(e){var i=t._,n=e.outputBuffer,s=n.length;if(i.totalWrite>i.totalRead+s){var r=i.readIndex,a=r+s;n.getChannelData(0).set(i.bufferL.subarray(r,a)),n.getChannelData(1).set(i.bufferR.subarray(r,a)),i.readIndex=a&i.buffermask,i.totalRead+=s}}},s=t.prototype;s.cancel=function(){e.prototype.cancel.call(this);var t=this._;null!==t.connectIndex?t.script.disconnect(t.connectIndex):t.script.disconnect(),this.unlisten()},s.send=function(t,e){var i=this._;try{i.node=t,"number"==typeof e?(i.script.connect(i.node,e),i.connectIndex=e):(i.script.connect(i.node),i.connectIndex=null),this.listen()}catch(n){i.node=null}return i.writeIndex=0,i.readIndex=0,i.totalWrite=0,i.totalRead=0,this},s.process=function(t){var e=this._;if(null===e.script)return this;if(this.tickID!==t){this.tickID=t;var n=this.cells[1],s=this.cells[2],r=e.cellsize,a=e.writeIndex;i.inputSignalAR(this),e.bufferL.set(n,a),e.bufferR.set(s,a),e.writeIndex=a+r&e.buffermask,e.totalWrite+=r,i.outputSignalAR(this)}return this},i.register("WebAudioAPI:send",t)}()}})(timbre);